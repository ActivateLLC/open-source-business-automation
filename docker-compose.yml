version: '3.8'

# ==============================================================================
# IMPORTANT SECURITY NOTICE: Before deploying to production, change all
# placeholder secrets below. Search for "change_me" and "supersecret" and
# replace with strong, randomly generated values.
#
# Generate secure random keys with:
#   openssl rand -base64 32
# ==============================================================================

services:
  # ===== FRONTEND / PLATFORM UI =====
  nocobase:
    image: nocobase/nocobase:latest
    restart: always
    ports:
      - "13000:80"
    environment:
      - DB_DIALECT=postgres
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_DATABASE=nocobase
      - DB_USER=admin
      - DB_PASSWORD=supersecret
      # SECURITY: Replace with a strong random key before production deployment
      - APP_KEY=change_me_please_use_strong_app_key
      - INIT_ROOT_EMAIL=admin@example.com
      - INIT_ROOT_PASSWORD=admin123
    volumes:
      - nocobase_storage:/app/nocobase/storage
    depends_on:
      - postgres

  # ===== AUTOMATION LAYER =====
  activepieces:
    image: activepieces/activepieces:latest
    restart: always
    ports:
      - "8080:80"
    environment:
      - AP_POSTGRES_HOST=postgres
      - AP_POSTGRES_PORT=5432
      - AP_POSTGRES_DATABASE=activepieces
      - AP_POSTGRES_USERNAME=admin
      - AP_POSTGRES_PASSWORD=supersecret
      - AP_REDIS_HOST=redis
      - AP_REDIS_PORT=6379
      # SECURITY: Replace with strong random keys before production deployment
      - AP_JWT_SECRET=change_me_please_use_strong_jwt_secret
      - AP_ENCRYPTION_KEY=change_me_please_use_strong_encryption_key_here
      - AP_FRONTEND_URL=http://localhost:8080
    depends_on:
      - postgres
      - redis

  temporal:
    image: temporalio/auto-setup:latest
    restart: always
    ports:
      - "7233:7233"
    environment:
      - DB=postgresql
      - DB_PORT=5432
      - POSTGRES_SEEDS=postgres
      - POSTGRES_USER=admin
      - POSTGRES_PWD=supersecret
    depends_on:
      - postgres

  temporal-ui:
    image: temporalio/ui:latest
    restart: always
    ports:
      - "8233:8080"
    environment:
      - TEMPORAL_ADDRESS=temporal:7233
      - TEMPORAL_CORS_ORIGINS=http://localhost:8233
    depends_on:
      - temporal

  kafka:
    image: apache/kafka:latest
    restart: always
    ports:
      - "9092:9092"
    environment:
      - KAFKA_NODE_ID=1
      - KAFKA_PROCESS_ROLES=broker,controller
      - KAFKA_LISTENERS=PLAINTEXT://:9092,CONTROLLER://:9093
      - KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://kafka:9092
      - KAFKA_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      - KAFKA_CONTROLLER_QUORUM_VOTERS=1@kafka:9093
      - KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR=1
      - KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR=1
      - KAFKA_TRANSACTION_STATE_LOG_MIN_ISR=1
      - KAFKA_LOG_DIRS=/tmp/kraft-combined-logs
      # IMPORTANT: Generate a unique cluster ID for production deployments using: 
      # docker run --rm apache/kafka:latest /opt/kafka/bin/kafka-storage.sh random-uuid
      # Then set the KAFKA_CLUSTER_ID environment variable before starting
      - CLUSTER_ID=${KAFKA_CLUSTER_ID:-REPLACE_WITH_UNIQUE_CLUSTER_ID}
    volumes:
      - kafka_data:/tmp/kraft-combined-logs

  # ===== DATA LAYER =====
  postgres:
    image: postgres:15
    restart: always
    environment:
      - POSTGRES_USER=admin
      - POSTGRES_PASSWORD=supersecret
      - POSTGRES_DB=business_automation
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-db.sql:/docker-entrypoint-initdb.d/init-db.sql
    ports:
      - "5432:5432"

  qdrant:
    image: qdrant/qdrant:latest
    restart: always
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant_data:/qdrant/storage
    environment:
      - QDRANT__SERVICE__GRPC_PORT=6334

  clickhouse:
    image: clickhouse/clickhouse-server:latest
    restart: always
    ports:
      - "8123:8123"
      - "9000:9000"
    volumes:
      - clickhouse_data:/var/lib/clickhouse
    environment:
      - CLICKHOUSE_DB=analytics
      - CLICKHOUSE_USER=admin
      - CLICKHOUSE_PASSWORD=supersecret

  redis:
    image: redis:7-alpine
    restart: always
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes

  # ===== ANALYTICS / BI LAYER =====
  superset:
    image: apache/superset:latest
    restart: always
    ports:
      - "8088:8088"
    environment:
      # SECURITY: Replace with a strong random key before production deployment
      - SUPERSET_SECRET_KEY=change_me_please_use_strong_secret_key_here
      - SUPERSET_LOAD_EXAMPLES=yes
    depends_on:
      - postgres
      - redis
    volumes:
      - superset_data:/app/superset_home
    command: >
      bash -c "
        superset db upgrade &&
        superset fab create-admin --username admin --firstname Admin --lastname User --email admin@example.com --password admin123 || true &&
        superset init &&
        superset run -h 0.0.0.0 -p 8088 --with-threads --reload
      "

  metabase:
    image: metabase/metabase:latest
    restart: always
    ports:
      - "3000:3000"
    environment:
      - MB_DB_TYPE=postgres
      - MB_DB_DBNAME=metabase
      - MB_DB_PORT=5432
      - MB_DB_USER=admin
      - MB_DB_PASS=supersecret
      - MB_DB_HOST=postgres
    volumes:
      - metabase_data:/metabase-data
    depends_on:
      - postgres

  grafana:
    image: grafana/grafana:latest
    restart: always
    ports:
      - "3001:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin123
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - grafana_data:/var/lib/grafana
    depends_on:
      - postgres
      - clickhouse

  # ===== LEGACY SUPPORT (n8n for backward compatibility) =====
  n8n:
    image: docker.n8n.io/n8nio/n8n
    restart: always
    ports:
      - "5678:5678"
    environment:
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - N8N_HOST=localhost
      - NODE_ENV=production
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=postgres
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_DATABASE=n8n
      - DB_POSTGRESDB_USER=admin
      - DB_POSTGRESDB_PASSWORD=supersecret
      # SECURITY: Replace with a strong random key before production deployment
      - N8N_ENCRYPTION_KEY=change_me_please_use_strong_encryption_key
    volumes:
      - ./data/n8n:/home/node/.n8n
    depends_on:
      - postgres

volumes:
  nocobase_storage:
  postgres_data:
  qdrant_data:
  clickhouse_data:
  redis_data:
  superset_data:
  metabase_data:
  grafana_data:
  kafka_data:
